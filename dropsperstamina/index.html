<!DOCTYPE html>
<meta charset=UTF-8>
<meta name=robots content="noindex,nofollow">
<meta name=viewport content="width=device-width,maximum-scale=1">
<title>LAH スタミナ効率計算</title>
<script>
"use strict"
onerror = function(m, s, l, c, e){alert(m + "\n\n" + e.stack)};

const quests = [
  {
    name: "力を求めてA級",
    stamina: 18,
    heroExp: 810,
    heroBand: 360,
    drops: [
      {
        label: "MIN",
        expItems: [300, 150, 100],
        bandItems: [150],
        coins: [720],
        eventItems: [],
        otherItems: [],
        probability: 0
      }, {
        label: "",
        expItems: [300, 150, 100, 160],
        bandItems: [150],
        coins: [720],
        eventItems: [],
        otherItems: [],
        probability: 0
      }, {
        label: "MAX",
        expItems: [300, 150, 100, 160, 200],
        bandItems: [150],
        coins: [720],
        eventItems: [],
        otherItems: [],
        probability: 0
      }
    ],
    eventRate: 1
  }, {
    name: "強制捜査！A級",
    stamina: 16,
    heroExp: 420,
    heroBand: 300,
    drops: [
      {
        label: "MIN",
        expItems: [],
        bandItems: [],
        coins: [],
        eventItems: [50, 30, 20],
        otherItems: [],
        probability: 0
      }, {
        label: "MAX",
        expItems: [],
        bandItems: [],
        coins: [],
        eventItems: [50, 30, 20, 20],
        otherItems: [],
        probability: 0
      }
    ],
    eventRate: 6
  }
];

const _ = (id) => document.getElementById(id);

const setOptions = (id, iter) => {
  const f = document.createDocumentFragment();
  for(const v of iter){
    const o = document.createElement("option");
    o.textContent = v;
    f.appendChild(o);
  }
  _(id).appendChild(f);
};

const output = () => {
  const expBonus = _("x").selectedIndex;
  const coinBonus = _("g").selectedIndex;
  const eventBonus = _("e").selectedIndex * 10;
  const mode = _("u").selectedIndex;
  const numHeroes = 4;
  const unit = ["s", "min", "h", "exp", "ラフ"][mode];
  const type = ["営業時間", "営業時間", "営業時間", "経験値", "ラフ"][mode];
  const result = [
    `「スタミナ1あたりの報酬」をすべて「${type}」に換算`,
    `条件: Exp+${expBonus}%, Coin+${coinBonus}%, Event+${eventBonus}%`
  ];
  for(const q of quests){
    const eventRate = q.eventRate || 1;
    const exp = (Math.floor(q.heroExp * (100 + expBonus) / 100) + q.heroBand) * numHeroes * 9 * eventRate;
    let average = 0;
    let numerator = q.stamina * eventRate;
    let p = 0;
    switch(mode){
      case 1:
        numerator *= 60;
        break;
      case 2:
        numerator *= 3600;
        break;
      case 3:
        numerator *= 9;
        break;
      case 4:
        numerator *= 6;
        break;
      default:
    }
    result.push("");
    result.push(`${q.name}:`);
    for(const d of q.drops){
      let t = (d.expItems.reduce(sum, 0) + d.bandItems.reduce(sum, 0)) * 9 * eventRate;
      t += d.coins.reduce((a, v) => a + Math.floor(v * (100 + coinBonus) / 100), 0) * 6 * eventRate;
      t += (d.eventItems.reduce((a, v) => a + Math.floor(v * (100 + eventBonus) / 100), 0) + d.otherItems.reduce(sum, 0)) * 900;
      t += exp;
      average += t * d.probability;
      p += d.probability;
      t = Math.round(t * 10000 / numerator) / 10000;
      if(d.label) result.push(`${d.label}: ${t}${unit}`);
    }
    if(p){
      average = Math.round(average * 10000 / (numerator * p)) / 10000;
      result.push(`期待値: ${average}${unit}`);
    }
  }
  _("o").value = result.join("\r\n");
};

const sum = (x, y) => x + y;

const copyText = (id) => {
  let r = 1;
  try{
    const range = document.createRange();
    range.selectNode(_(id));
    window.getSelection().addRange(range);
    if(document.execCommand("copy")) r = 0;
  }catch(e){
    r = 1;
  }
  alert(["コピーしました", "コピーに失敗しました"][r]);
};

const share = (data) => {
  try{
    navigator.share(data);
  }catch(e){}
};

onload = () => {
  const r = Array.from({length: 31}, (v, i) => `${i}%`);
  setOptions("x", r);
  setOptions("g", r);
  setOptions("e", Array.from({length: 9}, (v, i) => `${i * 10}%`));
  setOptions("u", ["秒", "分", "時間", "EXP", "ラフ"])
  if("share" in navigator){
    _("s").onclick = () =>{
      share({
        text: _("o").value,
        url: location.href
      });
    };
  }else{
    _("s").style.display = "none";
  }
  _("c").onclick = () => {
    copyText("o");
  };
  _("f").onchange = output;
  output();
};
</script>
<style>
* {
  margin: 0;
  padding: 0;
  font-family: monospace;
}
body {
  background-color: #ccc;
  -webkit-text-size-adjust: 100%;
}
body::before {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  content: "";
  z-index: -1;
  background-image: linear-gradient(#eee, #ccc);
  background-color: #eee;
}
form {
  margin: 0.5rem;
  line-height: 2.5;
}
#o {
  width: 25rem;
  height: 25rem;
  padding: 0.5rem;
  line-height: 2;
}
button {
  width: 5rem;
  height: 2rem;
  margin: 0 0.5rem;
}
</style>
<form id=f>
 <label for=u>単位：</label><select id=u></select><br>
 <hr>
 <label for=x>EXPボーナス：</label><select id=x></select><br>
 <label for=g>ラフボーナス：</label><select id=g></select><br>
 <label for=e>イベントボーナス：</label><select id=e></select><br>
 <textarea id=o></textarea><br>
 <button type=button id=c>コピー</button><button type=button id=s>共有</button>
</form>
